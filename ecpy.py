# Run "pip install ecpy" if ecpy is not installed
from random import randint, seed
from ecpy.curves import Curve, Point
from Crypto.Hash import SHA3_256, SHA256, HMAC
from Crypto import Random   # a bit better secure random number generation 
import math
from Client import IKRegReq, IKRegVerify, ResetIK, SPKReg, ResetSPK, OTKReg, ResetOTK

ID = 27804
 


E = Curve.get_curve("secp256k1")
n = E.order
P = E.generator

IKey_Ser = Point(0x1d42d0b0e55ccba0dd86df9f32f44c4efd7cbcdbbb7f36fd38b2ca680ab126e9 , 0xce091928fa3738dc18f529bf269ade830eeb78672244fd2bdfbadcb26c4894ff, E)

def key_generation():
    sA = randint(1, n - 2)
    QA = sA * P
    return sA, QA


def sign_message(message, sA, P, n):
    k = randint(1, n - 2)
    print("\nk: ", k)
    R = k * P
    r = R.x % n

    concatenated_data = r.to_bytes((r.bit_length() + 7) // 8, byteorder="big") + message.to_bytes((message.bit_length() + 7) // 8, byteorder="big")

    hash_object = SHA3_256.new(concatenated_data)
    h = int.from_bytes(hash_object.digest(), "big") % n

    s = (k - sA * h) % n

    return h, s




def verify_signature(message, signature, QA, P, n):
    h, s = signature

    V = s * P + h * QA
    v = V.x % n

    concatenated_data = v.to_bytes(
        (v.bit_length() + 7) // 8, byteorder="big"
    ) + message.to_bytes((message.bit_length() + 7) // 8, byteorder="big")

    hash_object = SHA3_256.new(concatenated_data)
    h_prime = int.from_bytes(hash_object.digest(), "big") % n

    return h == h_prime

message = 27804

h = 96929881781904626142062758481257561241529587740884413687044638136576526233426
s = 54668081252578300862120584750212422386558394786220563301283897725542604469825
IKPRI = 16583104134778130762479186827572996124244097953595394773612560901170604126940
IKPUB = Point(42962279252123192900230332240901450736038335793155372586682863834229270830844, 2141846162555728367847099143914084174553403144481850923314167063833809172935, E)
Code = 461974




"IKPUB.X = 42962279252123192900230332240901450736038335793155372586682863834229270830844"
"IKPUB.Y =  2141846162555728367847099143914084174553403144481850923314167063833809172935"
'''
# Key Generation
sA, QA = key_generation()
print("\nPrivate identity key: ", sA)
print("\nPublic identity key: ", QA)

message = 27804

signature = sign_message(message, sA, P, n)

print("\nSignature:", signature)

h = signature[0]
s = signature[1]


verification_result = verify_signature(message, signature, QA, P, n)
print("Verification Result:", verification_result)

IKRegReq(h, s, QA.x, QA.y)

Sending message is:  {'ID': 27804, 'H': 96929881781904626142062758481257561241529587740884413687044638136576526233426, 'S': 54668081252578300862120584750212422386558394786220563301283897725542604469825, 
'IKPUB.X': 42962279252123192900230332240901450736038335793155372586682863834229270830844, 'IKPUB.Y': 2141846162555728367847099143914084174553403144481850923314167063833809172935}

IKRegVerify(Code)

Sending message is:  {'ID': 27804, 'CODE': 461974}
'''



'''
SPK_sA, SPK_QA = key_generation()

print("SPK_sA: ", SPK_sA)
print("SPK_QA: ", SPK_QA)

SPK_Pub_x = SPK_QA.x
SPK_Pub_y = SPK_QA.y

SPK_k = randint(1, n -2)
SPK_R = SPK_k*P
SPK_r = (SPK_R.x) % n

SPK_msg = (SPK_Pub_x.to_bytes((SPK_Pub_x.bit_length()+7)//8, byteorder='big')) + (SPK_Pub_y.to_bytes((SPK_Pub_y.bit_length()+7)//8, byteorder='big'))

SPK_hash = SPK_r.to_bytes((SPK_r.bit_length()+7)//8, byteorder='big') + SPK_msg
SPK_h_obj = SHA3_256.new(SPK_hash)


SPK_h = (int.from_bytes(SPK_h_obj.digest(), byteorder='big'))% n
SPK_s = (SPK_k - (IKPRI*int.from_bytes(SPK_h_obj.digest(), byteorder='big'))) % n

SPKReg(SPK_h,SPK_s,SPK_Pub_x,SPK_Pub_y)


49290771587715627106395671788626317576427722885114087620560016522327430735892
(0xfcc2c6b06a8591853edddd4bd36ac8857e47c1ef9d032ea890dd9caa40c1f2f9 , 0x8d2f42254e31fa96c6e49c72bdc88be48670b49dd0107b8d3f68020da4dd9f7a)

Sending message is:  {'ID': 27804, 'H': 28009290297080776634495527422983143013633487077344156124881894570996222357802, 'S': 80534163738133958201908258495851899876450976667840071105276894656633690585230, 
'SPKPUB.X': 114326977475495464165969790244959537155926482324668715936678925914254801498873, 'SPKPUB.Y': 63859609983296978547840577527087298531932028823005975986253372687443260448634}
Server successfully verified your signature.

'''

r'''


SPK_sA = 49290771587715627106395671788626317576427722885114087620560016522327430735892
SPK_QA = Point(0xfcc2c6b06a8591853edddd4bd36ac8857e47c1ef9d032ea890dd9caa40c1f2f9 , 0x8d2f42254e31fa96c6e49c72bdc88be48670b49dd0107b8d3f68020da4dd9f7a, E)

T = SPK_sA * IKey_Ser

T_x = T.x
T_y = T.y

U = b'TheHMACKeyToSuccess' + T_y.to_bytes((T_y.bit_length()+7)//8, byteorder='big') + T_x.to_bytes((T_x.bit_length()+7)//8, byteorder='big') 
KHMAC = SHA3_256.new(U)

for i in range(0, 10):

    OTK_sA = randint(1, n - 2) 

    OTK_Pub = OTK_sA * P
    OTK_Pub_x = OTK_Pub.x
    OTK_Pub_y = OTK_Pub.y

    print("OTK_sA: ", OTK_sA)
    print("OTK_Pub: ", OTK_Pub)

    HMAC_hash = OTK_Pub_x.to_bytes((OTK_Pub_x.bit_length()+7)//8, byteorder='big') + OTK_Pub_y.to_bytes((OTK_Pub_y.bit_length()+7)//8, byteorder='big')

    HMACI = HMAC.new(msg=HMAC_hash, key=KHMAC.digest(), digestmod=SHA256)
    OTKReg(i, OTK_Pub_x, OTK_Pub_y, HMACI.hexdigest())





Sending message is:  {'ID': 27804, 'H': 2627475610570686071214318241844193354256451829390204305446499550124861605608, 'S': 53444589868874629670743062465330193903968839453511981173838812319575115782078}
The server couldn't verify the signature!!
OTK_sA:  6264987488498879018582768229839561547750201141651579435022294769411476758105
OTK_Pub:  (0x1a519b20049bd07f948a875ab3e90d8be9776fb0c0e6a4a9eb4d0fa707dff04f , 0xc9459371f39cda3d4accf70ece19d9f6491917b6dca77f90e0e11467cb97963)
Sending message is:  {'ID': 27804, 'KEYID': 0, 'OTKI.X': 11904319309299368626827970680888357891982356819768267901571713424469652402255, 'OTKI.Y': 5689863290096788527069021101738093192316280327626146403224220795376718412131, 'HMACI': 'de0b8ab3913a9464427b08be78a7edf1a05c5727158c14ad9b152c53da65fbfb'}
The server couldn't verify the hmac!!
OTK_sA:  111230422527223383436865160393856527524830630485981824372394901449508319469364
OTK_Pub:  (0x7341e08d3ffb009e9d871edcbd7c39cbd068132e2bd17ff5fc1035edd4389d37 , 0xc8eed7a638c72973988b2fad3cc3e6467032d549d1e85572d4318b771c820c8a)
Sending message is:  {'ID': 27804, 'KEYID': 1, 'OTKI.X': 52132372445558321580619442601717582125707208223659525152254215941023178726711, 'OTKI.Y': 90884567674865658658558968422570846839556843648175451269891014830072617110666, 'HMACI': '87d330ff0e8ba23445d1a6b5531ae71519ca1682636b40abffd874fa0e9f15cf'}
The server couldn't verify the hmac!!
OTK_sA:  53722776842809692138399925246702555153691679865661859768280806314886060762886
OTK_Pub:  (0xe337a6b9b34181ba56467854f4a1e57e0d0766e1b1e66f67c381c7234b8e011b , 0xdca0845d079634389456a7ff8a21fdb94ab11b3e8982be839dcceb7fff3a2785)
Sending message is:  {'ID': 27804, 'KEYID': 2, 'OTKI.X': 102773343913325830077721043671080574419808597293909081760870005730974741954843, 'OTKI.Y': 99792435757274939712806778776273044341859417303299620139268693712243827287941, 'HMACI': '896e44c096bbd3ff86e05c8d2082ab1a915743aa5521e154740a99bd7e5dc389'}
The server couldn't verify the hmac!!
OTK_sA:  33762177042142679727864853637485835502123916299470558164117365921320896961054
OTK_Pub:  (0x12d772dc375e52387af0ae71377f2cfaee4907af5889c6d6f9e4a62b90067ea5 , 0x6715fe888c3d2890f55bfbaddf41b72a85bfc85bd4a00edcf2fdcab90e44471)
Sending message is:  {'ID': 27804, 'KEYID': 3, 'OTKI.X': 8522296129528926041312270259706217517029953222146940250709020236977845730981, 'OTKI.Y': 2914192744833155973412526611743681677914483537043841705119138554406035014769, 'HMACI': '1cc9f181bc3b7ccc607f6ff396b17cedc84166d0c468ee2bf629b26a8bbf5749'}
The server couldn't verify the hmac!!
OTK_sA:  36353342141291509062413316817718266438684689754991074548390359346672293142399
OTK_Pub:  (0x6347bf9522d1c055b8302fdeef53b43e8fac53fb5595cd808969a6936afa9b75 , 0x267b1c2e26177b608c59d8dcfe6f888b504c83be32cfcb4ba3aac33478d2ed9a)
Sending message is:  {'ID': 27804, 'KEYID': 4, 'OTKI.X': 44905740405593832739513640292107949797383871404171785575793527423797294701429, 'OTKI.Y': 17405404928198647849472918546016975718471433298878422043627311852634070248858, 'HMACI': '096dd8ae7560bc608ae751fd197fdc4226664de900625ed315bb4e379be47dea'}
The server couldn't verify the hmac!!
OTK_sA:  101463241798727679600347552784237421883640032045593470511456176159116548452429
OTK_Pub:  (0x6868817751071f9e96985b91a685c0ecfa9c01e0ea939ac18096e3c8f54903f5 , 0xd0b4755be846f5b76e2234f513b68dfcd394b3abe64d52ddf5a94363078bfd03)
Sending message is:  {'ID': 27804, 'KEYID': 5, 'OTKI.X': 47225181889442271803439562967363904259159337010697803909642279021637760779253, 'OTKI.Y': 94399914959118882015737088017500235369085581607094153362093250111408618339587, 'HMACI': '7890d913ff6f30987ef80d23c1a1a061bc301872f532ccac3874e79c044e7eb4'}
The server couldn't verify the hmac!!
OTK_sA:  56679373976547252399748144217506372907091013320030361154003114161610886501879
OTK_Pub:  (0x472041038c3f52be518619fec2f919e42bb7449a1d6f9319791e77892c58fe87 , 0x27a54921159fe0f6170ccd0efee8e183c20d402cc540e438fa97b53ca4670963)
Sending message is:  {'ID': 27804, 'KEYID': 6, 'OTKI.X': 32171200064646973755094516227265495743923911278454344517408886136142894268039, 'OTKI.Y': 17932235579874706718115826528222975659827598260728664844828700519538012653923, 'HMACI': 'c2a93702d7365427d0316157bc5caa005e14f15faf7d56ef414b503f2367eeff'}
The server couldn't verify the hmac!!
OTK_sA:  52627536977235529133523037752170990345509189548958908533769707641980208518025
OTK_Pub:  (0xbae012fd636384ae6a2fa060ba3a757dab20297d28893b3437f942d848d451a5 , 0xe52731fe35fc6503f481fd2664222024bf97aafbf2931bca2429f19416c52680)
Sending message is:  {'ID': 27804, 'KEYID': 7, 'OTKI.X': 84526094641765511670147073935971843745329107836768038340967734479515825754533, 'OTKI.Y': 103648894400177186691346928725849633427598526918333772750298896198184837916288, 'HMACI': '82cc9c312b651f79d3daadc1419049cb249a9024d4a6fce3aaea03efd37a9d5f'}
The server couldn't verify the hmac!!
OTK_sA:  13514992609530838395127439862371338592360386473382410939723551372430414847752
OTK_Pub:  (0x863530efbcc00eef452b6afd0dac415a7b98fde1bf33b36abd61807fe0ea7ebc , 0xbc11ab952ac1ecb19446b4284e04026aab4d2889abb92dc5c19ac0b015c7916a)
Sending message is:  {'ID': 27804, 'KEYID': 8, 'OTKI.X': 60703902351720568859054197087263455946031696967132321918341221295747532226236, 'OTKI.Y': 85066036153915560336672162753562184284770348529379634156567014336266829795690, 'HMACI': '2a9be64c0c6e5e12f1ae7a1ae70746fb4b9044a6eeb77cfa5fc16040a0789fa7'}
The server couldn't verify the hmac!!
OTK_sA:  90845143576670481089671599902171383960272483357689853878086126515241591957574
OTK_Pub:  (0x374af6883433e15ec6d98b95dfe0f69bcbed1c76ac64ecedf21f7fab76c568e2 , 0x11e13a401770721a9420a5f2b6aabbb60f4c985b298210fe9e69e1873ee839b0)
Sending message is:  {'ID': 27804, 'KEYID': 9, 'OTKI.X': 25009654856524890517954836904012900752146795136365012759582983332811963197666, 'OTKI.Y': 8087261044683805820598946964014438585570015452561058844632214597225547315632, 'HMACI': '724b77e4b589a71958e8ea79e4db92b1a8d3aa69d12594e85eb3b0d9ce5a5737'}
The server couldn't verify the hmac!!
PS C:\Users\Fethi\Desktop\Ders\CS411_project\new> python ecpy_sample.py
Sending message is:  {'ID': 27804, 'H': 2627475610570686071214318241844193354256451829390204305446499550124861605608, 'S': 53444589868874629670743062465330193903968839453511981173838812319575115782078}
The server couldn't verify the signature!!
OTK_sA:  24638080340697269625351667433782895580271031422509649179153236656445808953398
OTK_Pub:  (0x72f03403478ebed6e69738a2b70614b2f86c41be94dfca62eadc19ec56705b0d , 0x42d1f0118db883ef232c736a313ce12ee8cb1b15954364f0c35e8b5412e6e73c)
Sending message is:  {'ID': 27804, 'KEYID': 0, 'OTKI.X': 51988067013264948411862523011065247648236300170431227385435401052141489511181, 'OTKI.Y': 30223575935401525379269071135872946960862179707883769949253542313854344030012, 'HMACI': '1947393e6f0d99aa57a56aa803ac4277c77b332c7b4e76d4c2b84ae3564add94'}
OTK with ID number 0 is registered successfully
OTK_sA:  32599619545465127796735019210086351515155628004617268632494917860888799194910
OTK_Pub:  (0x2034b68cbc38db0efac697d83e3ba37075773824795a3db26ce7ff2f5cbbe817 , 0xd5d02736c6fcd042ab7df910d187ab74b5f0d402d2dce2d50d0651e1549f94ad)
Sending message is:  {'ID': 27804, 'KEYID': 1, 'OTKI.X': 14567147114082749607734957580785004546589507572984940512961812529604577716247, 'OTKI.Y': 96710411582610124721286083828266294565694928549997375835517500600933320463533, 'HMACI': 'bc37810734ebae7d374a4ca465bf30586ffa2564e7b4a16e62d71b2e2c421fdf'}
OTK with ID number 1 is registered successfully
OTK_sA:  109059122358460010081621828218827223785703360692726358637452158045351376225151
OTK_Pub:  (0xebe53e2af9780d201070fc2c99bd5917783acc52b37f94feb150a775df03b95b , 0xc21127cf1c3910aa5b79a712012b8d06e51605a4f0ed01c2ee2eae0f3966c51d)
Sending message is:  {'ID': 27804, 'KEYID': 2, 'OTKI.X': 106698556461765259168142792348360932032946943033170967578002764192572166617435, 'OTKI.Y': 87779003777043616197218347672642479524325094904955793211646075383776232785181, 'HMACI': '723b46b5bec2cfe62dc23b4c43324ec5d39c85ba8931df8a354b27f6ca5761ea'}
OTK with ID number 2 is registered successfully
OTK_sA:  24041442654401691811931826355138721420332447956728157027936047166785374406973
OTK_Pub:  (0xd3fced030c61586f57f2809cf0681764855e5159b4e0223f0733e075976b546e , 0x3ca0ac11c5060a0f0be255951aa06737aeac6987056fdc231ed953d188246257)
Sending message is:  {'ID': 27804, 'KEYID': 3, 'OTKI.X': 95884892307461183257896304005213494189086458826543557231635083342412755194990, 'OTKI.Y': 27422654024800271993035206443032224550702531493439520474542275864421441233495, 'HMACI': '8de9c399c880cf9836ded95d5f26e99fa0cc364992189eb97c8649610030f7f9'}
OTK with ID number 3 is registered successfully
OTK_sA:  102961941585666920791631738253928309885512791565043310924910805032658124076769
OTK_Pub:  (0x777382b663f42fb0e2e2d7a99ba6bda0cfcad6ad7fb6f3943661c4fd2ef42873 , 0x84df6c8d8c9a85cc4dc03d5cd8ec90ec127e3a7453a2ca916f5e5b1b94da45ff)
Sending message is:  {'ID': 27804, 'KEYID': 4, 'OTKI.X': 54029318538119959898641435139358942120398261050431291126165157568071970596979, 'OTKI.Y': 60100052113201964184155078935716942137576316378201274591211385972942725334527, 'HMACI': '5e8652b13a7da86e8e6d38e1816f1fa678c1f8efe56bd89b1f5cc74b27380a71'}
OTK with ID number 4 is registered successfully
OTK_sA:  26398556156005720932371135899215816112619418251856471313843094584608875195974
OTK_Pub:  (0x7915a8fafe83e2225da2106d9809f7fff634fa95bda0c0220234a8fb1a837299 , 0x655697fdbc1f5f07a59c83c753b883b4c7c2cd50c66037d56ea819ba36a41d6c)
Sending message is:  {'ID': 27804, 'KEYID': 5, 'OTKI.X': 54768124727112082408250842819010135886599725025215395455130937039684655870617, 'OTKI.Y': 45836595558857334643416361024626130438116321814741803508739224368727283998060, 'HMACI': '3b6839a9bf4e07797da0f8897d760d8bd110d9ba549ae88c343089537bab8bbf'}
OTK with ID number 5 is registered successfully
OTK_sA:  50318929780526501209569059548297177484737770118534938061653991537819661713349
OTK_Pub:  (0xfdc7a4676eac164b3bd20b02fe364b239e31f3515f3f07461f98652482d6c336 , 0x65367e6c97309ae897fb3c5c45cb5e58b695a59bafa38ce53209a7aa09ff2fe8)
Sending message is:  {'ID': 27804, 'KEYID': 6, 'OTKI.X': 114787887932387819713407627044314092857476496962114484651493890631587696395062, 'OTKI.Y': 45779879996044024667922533839680224314483243664516002107051945286742778523624, 'HMACI': 'fc5c55ef120bf8c590a670af9f6bfab32f0beef32d865c5ee6e6c50b99ce4986'}
OTK with ID number 6 is registered successfully
OTK_sA:  57641810580856368253273096605165287080310246674376738749589121706263051537896
OTK_Pub:  (0xa2c6b367015fd9e759587629ef287896e108c010b1004eec002b339695125a41 , 0xac47e74828ca3d4c3d21609d40686cd856327aeba2fe4f144354f7ddc288db5e)
Sending message is:  {'ID': 27804, 'KEYID': 7, 'OTKI.X': 73625755378930600423831644019367630777076261688140030329239322209049805740609, 'OTKI.Y': 77924852346739040891359484948360144419431846715880843216728313895633916844894, 'HMACI': 'fdcde3e0a7629d2f9ee30d521d5656f0f739114bfa0521eb036a3fbebacc730a'}
OTK with ID number 7 is registered successfully
OTK_sA:  25624327842386719810459083293797035825128086068196401456151007543121845987498
OTK_Pub:  (0x9b7c00fb7eb5558611bb3ff6519ff2139de05e03c3ddbb04423ce391287657da , 0x92fd6fd06fa2dbb10156bc0fd684e3dbca4dc36c4c336488921778d3f2b97a29)
Sending message is:  {'ID': 27804, 'KEYID': 8, 'OTKI.X': 70327587346729368572301320594168939370832922249439562842072994902177297618906, 'OTKI.Y': 66485459913815884798096268109068169864003496189433765529063933732886442244649, 'HMACI': '0bac3e22ca4c5eaa84430c131b8f6551dfd26221fc4080bc02b899d5562df105'}
OTK with ID number 8 is registered successfully
OTK_sA:  89415188849592618529450572442975977280178095035480278680525723252334506482088
OTK_Pub:  (0x47d9efbcbeced910a27ced0df97370ad4ec15adab09e85529b37668a6511260c , 0x46b6aa0bad895851554ef044fed0c883e9c3c15788d4efc8ded3d86a75a3dd9)
Sending message is:  {'ID': 27804, 'KEYID': 9, 'OTKI.X': 32499272668410107054792402761083580918877596781086431795763662257117325239820, 'OTKI.Y': 1999039948645762986215705482391741172191037830537860596977759232920265571801, 'HMACI': 'eab6ae307d9d0c4e72b1cd15f0a9a567c59979b08d54a2da1c9af76fa566300b'}
OTK with ID number 9 is registered successfully

'''

